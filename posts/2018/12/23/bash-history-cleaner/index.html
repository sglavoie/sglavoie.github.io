<!DOCTYPE html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.sglavoie.com/theme/css/style.css"
        />
        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.sglavoie.com/theme/css/pygments.css"
        />

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="Sébastien Lavoie" />
        <meta
            name="description"
            content="Posts and writings by Sébastien Lavoie. Customization setups and articles on productivity for developers who like minimalism."
        />
        <meta name="title" property="og:title" content="sglavoie.com" />
        <meta property="og:type" content="Website" />
        <meta
            name="image"
            property="og:image"
            content="https://www.sglavoie.com/theme/images/logo_1200x627.png"
        />

         <link
            href="https://www.sglavoie.com/feeds/sglavoie.rss.xml"
            type="application/rss+xml"
            rel="alternate"
            title="sglavoie.com RSS"
        />

        <!-- Favicon -->
        <link
            rel="apple-touch-icon"
            href="/theme/favicon/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/theme/favicon/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/theme/favicon/favicon-16x16.png"
        />
        <link rel="manifest" href="/theme/favicon/site.webmanifest" />
        <link
            rel="mask-icon"
            href="/theme/favicon/safari-pinned-tab.svg"
            color="#5bbad5"
        />
        <link rel="shortcut icon" href="/theme/favicon/favicon.ico" />
        <meta name="msapplication-TileColor" content="#2d89ef" />
        <meta
            name="msapplication-TileImage"
            content="/theme/favicon/mstile-144x144.png"
        />
        <meta
            name="msapplication-config"
            content="/theme/favicon/browserconfig.xml"
        />
        <meta name="theme-color" content="#000000" />
        <meta
            name="msapplication-config"
            content="/theme/favicon/browserconfig.xml"
        />
        <meta name="theme-color" content="#000000" />

      <meta name="keywords" content="bash, linux, python, regex, script, terminal">

      <!-- Open graph for social networks -->
      <meta name="og:title" property="og:title" content="If you ever wanted to automatically clean your Bash history file, here is a working solution written in Python that uses regular expressions to set any kind of pattern you might be looking for.">

        <title>sglavoie.com &ndash; Bash History&nbsp;Cleaner</title>

        <!-- Enable tracking of web traffic -->
<script type="text/javascript">
    var _gaq = _gaq || []
    _gaq.push(['_setAccount', 'UA-150998392-1'])
    _gaq.push(['_trackPageview'])
    ;(function () {
        var ga = document.createElement('script')
        ga.type = 'text/javascript'
        ga.async = true
        ga.src =
            ('https:' == document.location.protocol
                ? 'https://ssl'
                : 'http://www') + '.google-analytics.com/ga.js'
        var s = document.getElementsByTagName('script')[0]
        s.parentNode.insertBefore(ga, s)
    })()
</script>
     </head>

    <body>
        <aside>
            <div id="user_meta">
                <a href="https://www.sglavoie.com">
                    <div>
                        <svg
                            width="24.348mm"
                            height="24.348mm"
                            version="1.1"
                            viewBox="0 0 24.348095 24.347754"
                            xmlns="http://www.w3.org/2000/svg"
                            xmlns:cc="http://creativecommons.org/ns#"
                            xmlns:dc="http://purl.org/dc/elements/1.1/"
                            xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                        >
                            <metadata>
                                <rdf:RDF>
                                    <cc:Work rdf:about="">
                                        <dc:format>image/svg+xml</dc:format>
                                        <dc:type
                                            rdf:resource="http://purl.org/dc/dcmitype/StillImage"
                                        />
                                        <dc:title />
                                    </cc:Work>
                                </rdf:RDF>
                            </metadata>
                            <g transform="translate(81.397 -84.454)">
                                <path
                                    d="m-57.049 105.9v2.9029h-11.173v-2.9029z"
                                    fill="#c0c0c0"
                                >
                                    <animate
                                        attributeName="fill"
                                        values="white;grey;white"
                                        dur="2s"
                                        repeatCount="indefinite"
                                    />
                                </path>
                                <path
                                    d="m-72.272 98.481-9.1246 5.7598v-3.548l5.8658-3.5019v-0.09215l-5.8658-3.5019v-3.548l9.1246 5.7598z"
                                    fill="#c0c0c0"
                                />
                                <path
                                    transform="scale(.26458)"
                                    d="m-273.15 319.2-27.588 14.77 8.498 5.3613 19.09-12.049zm15.309 25.67v44.412h8.8672v-35.635h33.361v-8.7773h-33.783zm25.336 24.66v8.7774h8.0254v10.975h8.8672v-19.752z"
                                    fill="#007bff"
                                />
                            </g>
                        </svg>
                    </div>
                </a>
                <ul>
                      <li><a href="https://www.sglavoie.com/category/automation.html">automation</a></li>
                    <li><a href="https://www.sglavoie.com/category/tips-and-tricks.html">tips-and-tricks</a></li>
                    <li><a href="https://www.sglavoie.com/category/tools.html">tools</a></li>
                    <li><a href="https://www.sglavoie.com/category/workflow.html">workflow</a></li>
                  </ul>
            </div>
        </aside>

        <main>
            <header>
                <p>
                    <a href="https://www.sglavoie.com">Index</a> &brvbar;
                    <a href="https://www.sglavoie.com/archives.html">Archives</a> &brvbar;
                    <a href="https://www.sglavoie.com/tags.html">Tags</a> &brvbar;
                    <a href="https://www.sglavoie.com/learning-progress.html"
                        >Learning Progress</a
                    >
                    &brvbar;
                    <a href="https://www.sglavoie.com/contact.html">Contact</a> &brvbar;
                    <a
                        href="https://drive.google.com/file/d/1t6GdZjC13naJXVGe6RinGowZLfkRzjy_/view"
                        target="_blank"
                        rel="noopener noreferrer"
                        >Resume</a
                    >
                </p>
            </header>

<article>
  <div class="article_title">
    <h1><a href="https://www.sglavoie.com/posts/2018/12/23/bash-history-cleaner/">Bash History&nbsp;Cleaner</a></h1>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 8 minutes</p>
  </div>
    <nav class="toc">
    <div class="toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#make-history-in-a-big-way">Make history in a big way</a></li>
<li><a href="#bash-history-cleaner">Bash History Cleaner</a><ul>
<li><a href="#bash_history_cleanerpy">bash_history_cleaner.py</a></li>
<li><a href="#settingsjson">settings.json</a></li>
<li><a href="#description-of-available-settings-in-settingsjson">Description of available settings in settings.json</a></li>
</ul>
</li>
<li><a href="#anecdotal-evidence-of-satisfying-performances">Anecdotal evidence of satisfying performances</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
    </nav>
  <div class="article_text">
    
<hr/>
<h1 id="introduction">Introduction</h1>
<p>This is a Python 3.6+ script that helps to clean the file containing
the Bash history commands. It will remove any line matching a specified
regular expression and can also remove any line starting with an alias.</p>
<p>The idea behind this small utility was simple:</p>
<ul>
<li>The Bash history file (usually located in <code>~/.bash_history</code>) contains
    much of the work one ends up doing in the terminal.</li>
<li>The history can grow large over time and it becomes more cumbersome to
    find interesting information in all that clutter, such as a rarely used
    command with specific flags.</li>
<li>By removing all superfluous commands that are repeated often and which
    give no real benefit in certain contexts (such as <code>ls</code>, <code>cd</code>, <code>cat</code>,
    etc.), the history is much cleaner and easier to navigate and actually
    becomes much more useful in my opinion.</li>
<li>True, it will be harder to follow the bread crumbs for everything
    you did, but I haven’t come across a situation where having access
    to yet another empty <code>ls</code> or <code>cd</code> has proven necessary and reading
    <code>.bash_history</code> doesn’t make for a great narrative story either.</li>
</ul>
<hr/>
<h1 id="make-history-in-a-big-way">Make history in a big way</h1>
<p>I took advantage of the fact that the history can be cleaned with the
script you are about to see and set up what is known as an <em>eternal
history</em> which, as it sounds like, can grow infinitely big! All you have
to do is append the following lines to the file <code>~/.bashrc</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Eternal bash history.</span>
<span class="c1"># ---------------------</span>
<span class="c1"># Undocumented feature which sets the size to "unlimited".</span>
<span class="c1"># http://stackoverflow.com/questions/9457233/unlimited-bash-history</span>
<span class="nb">export</span> <span class="nv">HISTFILESIZE</span><span class="o">=</span>-1
<span class="nb">export</span> <span class="nv">HISTSIZE</span><span class="o">=</span>-1
<span class="nb">export</span> <span class="nv">HISTTIMEFORMAT</span><span class="o">=</span><span class="s2">"[%F %T] "</span>
<span class="c1"># Change the file location because certain bash sessions truncate</span>
<span class="c1"># .bash_history file upon close.</span>
<span class="c1"># http://superuser.com/questions/575479/bash-history-truncated-to-500-lines-on-each-login</span>
<span class="nb">export</span> <span class="nv">HISTFILE</span><span class="o">=</span>~/.bash_eternal_history
<span class="c1"># Force prompt to write history after every command.</span>
<span class="c1"># http://superuser.com/questions/20900/bash-history-loss</span>
<span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">"history -a; </span><span class="nv">$PROMPT_COMMAND</span><span class="s2">"</span>
</code></pre></div>
<hr/>
<h1 id="bash-history-cleaner">Bash History Cleaner</h1>
<p>And here is the script in question *. It comes in two files that need to be in the same directory:</p>
<ul>
<li>One is a Python file that needs to be launched from the terminal with
    Python 3.</li>
<li>The other file, <code>settings.json</code>, is a <span class="caps">JSON</span> file used to store the
    settings of the script, which will be detailed below.</li>
</ul>
<p>* <sub>Improvements to the original script can be found on <a href="https://github.com/sglavoie/python-utilities/tree/main/bash_history_cleaner">Github</a>. To keep this
article a bit more readable, the original version is shown.</sub></p>
<h2 id="bash_history_cleanerpy"><code>bash_history_cleaner.py</code></h2>
<div class="highlight"><pre><span></span><code><span class="sd">'''</span>
<span class="sd">Python script that helps to clean the file containing the Bash history</span>
<span class="sd">commands.</span>

<span class="sd">Note: Requires Python 3.6+</span>

<span class="sd">It will remove any line matching a specified regular expression and can</span>
<span class="sd">also remove any line starting with an alias.</span>

<span class="sd">Description of available settings in `settings.json`:</span>

<span class="sd">    "home_directory":   Absolute path to user's home directory.</span>

<span class="sd">    "history_file":     Name of file where the history will be cleaned up.</span>

<span class="sd">    "aliases_file":     Name of file where Bash aliases are set up.</span>

<span class="sd">    "ignore_patterns":  List of patterns to ignore in `history_file`.</span>
<span class="sd">                        Each line where a pattern is found will be deleted.</span>
<span class="sd">                            → Patterns are specified as regular expressions.</span>

<span class="sd">    "add_aliases":      Boolean. If set to `true`, aliases from `aliases_file`</span>
<span class="sd">                        will be added to `ignore_patterns`.</span>

<span class="sd">    "aliases_match_greedily":</span>
<span class="sd">                        Boolean. If set to `true`, any line in `history_file`</span>
<span class="sd">                        starting with an alias in `aliases_file` will be</span>
<span class="sd">                        deleted. If set to `false`, delete line if the alias is</span>
<span class="sd">                        the content of the whole line (with optional space at</span>
<span class="sd">                        the end): `false` matches "^alias$" or "^alias $" only.</span>

<span class="sd">    "backup_history":   Boolean. If set to `true`, `history_file` will be backed</span>
<span class="sd">                        up in the same directory with a name ending in .bak</span>
<span class="sd">                        based on the current date.</span>

<span class="sd">    "delete_logs_without_confirming":</span>
<span class="sd">                        Boolean. If set to `true`, script with flag `-c` will</span>
<span class="sd">                        automatically delete all the backup files found for</span>
<span class="sd">                        `history_file`.</span>
<span class="sd">'''</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">get_current_path</span><span class="p">():</span>
    <span class="sd">'''Returns the current working directory relative to where this script</span>
<span class="sd">    is being executed.'''</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">user_says_yes</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
    <span class="sd">'''Check if user input is either 'y' or 'n'. Returns a boolean.'''</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">'y'</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">'n'</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Please enter either 'y' or 'n'."</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">choice</span>


<span class="k">def</span> <span class="nf">delete_logs</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">history_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">'''Delete log files in `home_directory` based on `history_file`.'''</span>

    <span class="c1"># Retrieve a list of all matching log files</span>
    <span class="n">log_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">history_file</span><span class="si">}</span><span class="s1">_*.bak'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_files</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"There is no log file to delete."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Log files found in </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s2">"home_directory"</span><span class="p">]</span><span class="si">}</span><span class="s1">:'</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">'delete_logs_without_confirming'</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Log files deleted.'</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Do you want to delete those log files? [y/n] "</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user_says_yes</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Log files deleted.'</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'Operation aborted.'</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">generate_date_string</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">'''Return date formatted string to backup a file.'''</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="s1">'_%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S.bak'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_settings</span><span class="p">(</span><span class="n">settings_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">'''Load settings in the script. Return them as a dictionary.'''</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">read_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">settings</span>


<span class="k">def</span> <span class="nf">get_list_aliases</span><span class="p">(</span><span class="n">bash_aliases_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">'''Retrieve the name of all the aliases specified in `bash_aliases_file`.</span>

<span class="sd">    Return aliases as a list of strings formatted as regular expressions.'''</span>

    <span class="n">match_whole_line</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">'aliases_match_greedily'</span><span class="p">])</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bash_aliases_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>  <span class="c1"># one alias per line</span>
        <span class="n">aliases_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the actual alias in each line</span>
                <span class="c1"># Use negative lookbehind to remove 'alias ' at the beginning.</span>
                <span class="c1"># Matches anything after that is a dot, digit, underscore</span>
                <span class="c1"># or letter (will stop at the equal sign: alias blah='...')</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(?&lt;!not )alias ([\.\w]*)'</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># If for some reason the alias cannot be extracted, skip it</span>
            <span class="c1"># If search doesn't match, it's of type None and won't work</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">match_whole_line</span><span class="p">:</span>
                <span class="c1"># Match the whole line if it starts with the alias.</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'^</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s1">( )?$|^</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s1"> .*'</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Will match only when alias is the whole content of the line,</span>
                <span class="c1"># followed by optional space.</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'^</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s1">( )?$'</span>

            <span class="c1"># Escape dots in alias</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">({</span><span class="s2">"."</span><span class="p">:</span>  <span class="sa">r</span><span class="s2">"\."</span><span class="p">}))</span>

            <span class="n">aliases_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aliases_list</span>


<span class="k">def</span> <span class="nf">clean_bash_history</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">history_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">'''Modify in place `history_file` by removing every line where</span>
<span class="sd">    `ignore_patterns` is found.</span>

<span class="sd">    Optionally, add a list of aliases to `ignore_patterns` with</span>
<span class="sd">    `aliases` based on the value of `add_aliases` in settings.json.'''</span>

    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">'backup_history'</span><span class="p">]:</span>
        <span class="n">backup_str</span> <span class="o">=</span> <span class="n">generate_date_string</span><span class="p">()</span>
        <span class="n">file_input</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span>
                                         <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">backup</span><span class="o">=</span><span class="n">backup_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_input</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span>
                                         <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">file_input</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">has_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">'ignore_patterns'</span><span class="p">]:</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">search</span>
                <span class="k">if</span> <span class="n">matched</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">has_match</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="c1"># If no match is found (nothing to ignore), print the line</span>
            <span class="c1"># back into the file. Otherwise, it will be empty.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_match</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>  <span class="c1"># Line already has carriage return</span>


<span class="k">def</span> <span class="nf">launch_cleanup</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">history_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">aliases_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">'''Main function that launches the cleanup process.'''</span>

    <span class="n">bash_aliases</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">'add_aliases'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bash_aliases</span> <span class="o">=</span> <span class="n">get_list_aliases</span><span class="p">(</span><span class="n">aliases_file</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

            <span class="c1"># add aliases to list of patterns to ignore</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">'ignore_patterns'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bash_aliases</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File not found: </span><span class="si">{</span><span class="n">aliases_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">quit</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clean_bash_history</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">history_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File not found: </span><span class="si">{</span><span class="n">history_file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">SETTINGS_FILE_PATH</span> <span class="o">=</span> <span class="n">get_current_path</span><span class="p">()</span> <span class="o">/</span> <span class="s1">'settings.json'</span>
    <span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">load_settings</span><span class="p">(</span><span class="n">SETTINGS_FILE_PATH</span><span class="p">)</span>
    <span class="n">ALIASES_FILE</span> <span class="o">=</span> <span class="n">SETTINGS</span><span class="p">[</span><span class="s1">'home_directory'</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">SETTINGS</span><span class="p">[</span><span class="s1">'aliases_file'</span><span class="p">]</span>
    <span class="n">HISTORY_FILE</span> <span class="o">=</span> <span class="n">SETTINGS</span><span class="p">[</span><span class="s1">'home_directory'</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">SETTINGS</span><span class="p">[</span><span class="s1">'history_file'</span><span class="p">]</span>

    <span class="c1"># initiate the parser to check all the arguments passed to the script</span>
    <span class="n">PARSER</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">PARSER</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">'-c'</span><span class="p">,</span> <span class="s1">'--clear'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'Delete all log files'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">)</span>

    <span class="c1"># read arguments from the command line</span>
    <span class="n">ARGUMENTS</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ARGUMENTS</span><span class="o">.</span><span class="n">clear</span><span class="p">:</span>
        <span class="n">delete_logs</span><span class="p">(</span><span class="n">SETTINGS</span><span class="p">,</span> <span class="n">HISTORY_FILE</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">()</span>

    <span class="n">launch_cleanup</span><span class="p">(</span><span class="n">SETTINGS</span><span class="p">,</span> <span class="n">HISTORY_FILE</span><span class="p">,</span> <span class="n">ALIASES_FILE</span><span class="p">)</span>
</code></pre></div>
<h2 id="settingsjson"><code>settings.json</code></h2>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"home_directory"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/home/sglavoie"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"history_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">".bash_eternal_history"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"add_aliases"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"aliases_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">".bash_aliases"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"aliases_match_greedily"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"backup_history"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"delete_logs_without_confirming"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"ignore_patterns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^\\#\\d+"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^(\\.\\/)?pip$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^(\\.\\/)?python.*$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^\\.\\.$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^alias"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^cd "</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^cd$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^cd..$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^fg$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^df( )?"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^du( )?"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^exit$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^git branch"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^git checkout master"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^git log$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^git push$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^git status$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^git stauts$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^kill \\d+.*"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^ls -a$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^ls$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^make|make install$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^man "</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^pelican( )?$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^pip install -r requirements.txt"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^pip.* list|pip.* show$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^source "</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^sudo apt-get autoclean|sudo apt-get autoremove$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^sudo apt-get dist-upgrade|sudo apt-get update$"</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">"^which "</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<hr/>
<h2 id="description-of-available-settings-in-settingsjson">Description of available settings in <code>settings.json</code></h2>
<div style="overflow-x: auto"><table>
<thead>
<tr>
<th>Name of setting</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>home_directory</code></td>
<td>Absolute path to user’s home directory.</td>
</tr>
<tr>
<td><code>history_file</code></td>
<td>Name of file where the history will be cleaned up.</td>
</tr>
<tr>
<td><code>aliases_file</code></td>
<td>Name of file where Bash aliases are set up.</td>
</tr>
<tr>
<td><code>ignore_patterns</code></td>
<td>List of patterns to ignore in <code>history_file</code>. Each line where a pattern is found will be deleted. Patterns are specified as regular expressions.</td>
</tr>
<tr>
<td><code>add_aliases</code></td>
<td>Boolean. If set to <code>true</code>, aliases from <code>aliases_file</code> will be added to <code>ignore_patterns</code>. (Default: <code>true</code>)</td>
</tr>
<tr>
<td><code>aliases_match_greedily</code></td>
<td>Boolean. If set to <code>true</code>, any line in <code>history_file</code> starting with an alias in <code>aliases_file</code> will be deleted. If set to <code>false</code>, delete line if the alias is the content of the whole line (with optional space at the end): <code>false</code> matches “^alias$” or “^alias $” only.</td>
</tr>
<tr>
<td><code>backup_history</code></td>
<td>Boolean. If set to <code>true</code>, <code>history_file</code> will be backed up in the same directory with a name ending in .bak based on the current date. (Default: <code>true</code>)</td>
</tr>
<tr>
<td><code>delete_logs_without_confirming</code></td>
<td>Boolean. If set to <code>true</code>, script with flag <code>-c</code> will automatically delete all the backup files found for <code>history_file</code>. (Default: <code>false</code>)</td>
</tr>
</tbody>
</table></div>
<hr/>
<h1 id="anecdotal-evidence-of-satisfying-performances">Anecdotal evidence of satisfying performances</h1>
<p>Performance-wise, this scans ~8,300 lines per second on my modest Intel
Core i5 laptop with files of over 200,000 lines long. Not that I type so
much stuff in the terminal: I just duplicated many lines.</p>
<hr/>
<h1 id="conclusion">Conclusion</h1>
<p>This is a simple solution to an nonexistent problem, but it was
in the end very instructive to me nonetheless. You may even find
a use for it! Otherwise, you might use the same functions for
other files such as logs! If you would like to take a closer look
at the source in a more convenient way, you can find the code <a href="https://github.com/sglavoie/python-utilities/tree/main/bash_history_cleaner">available on Github</a>.</p>
  </div>
  <div class="article_meta">
    <p>Posted on: Sun 23 December 2018</p>
     <time class="modified" datetime="2019-01-06T14:37:00-06:00">
      Modified on: Sun 06 January 2019
    </time>
    <p>Category: <a href="https://www.sglavoie.com/category/automation.html">automation</a>
 &ndash; Tags:
      <a href="https://www.sglavoie.com/tag/bash.html">bash</a>,      <a href="https://www.sglavoie.com/tag/linux.html">linux</a>,      <a href="https://www.sglavoie.com/tag/python.html">python</a>,      <a href="https://www.sglavoie.com/tag/regex.html">regex</a>,      <a href="https://www.sglavoie.com/tag/script.html">script</a>,      <a href="https://www.sglavoie.com/tag/terminal.html">terminal</a>    </p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "posts/2018/12/23/bash-history-cleaner/";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = '//sglavoie.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>
  
            <div id="ending_message">
                <p>
                    &copy; Sébastien Lavoie. Built in
                    <a
                        href="https://www.python.org/"
                        target="_blank"
                        rel="noopener noreferrer"
                        >Python</a
                    >
                    using
                    <a
                        href="http://getpelican.com"
                        target="_blank"
                        rel="noopener noreferrer"
                        >Pelican</a
                    >
                    v4.7.2. Theme adapted from Giulio Fidente on
                    <a
                        href="https://github.com/gfidente/pelican-svbhack"
                        target="_blank"
                        rel="noopener noreferrer"
                        >GitHub</a
                    >.
                    <a href="https://www.sglavoie.com/feeds/sglavoie.rss.xml">RSS feed</a>.
                </p>
            </div>
        </main>
    </body>
</html>