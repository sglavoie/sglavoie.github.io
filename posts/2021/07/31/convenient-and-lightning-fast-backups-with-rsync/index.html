<!DOCTYPE html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.sglavoie.com/theme/css/style.css"
        />
        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.sglavoie.com/theme/css/pygments.css"
        />

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="Sébastien Lavoie" />
        <meta
            name="description"
            content="Posts and writings by Sébastien Lavoie. Customization setups and articles on productivity for developers who like minimalism."
        />
        <meta name="title" property="og:title" content="sglavoie.com" />
        <meta property="og:type" content="Website" />
        <meta
            name="image"
            property="og:image"
            content="https://www.sglavoie.com/theme/images/logo_1200x627.png"
        />

         <link
            href="https://www.sglavoie.com/feeds/sglavoie.rss.xml"
            type="application/rss+xml"
            rel="alternate"
            title="sglavoie.com RSS"
        />

        <!-- Favicon -->
        <link
            rel="apple-touch-icon"
            href="/theme/favicon/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/theme/favicon/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/theme/favicon/favicon-16x16.png"
        />
        <link rel="manifest" href="/theme/favicon/site.webmanifest" />
        <link
            rel="mask-icon"
            href="/theme/favicon/safari-pinned-tab.svg"
            color="#5bbad5"
        />
        <link rel="shortcut icon" href="/theme/favicon/favicon.ico" />
        <meta name="msapplication-TileColor" content="#2d89ef" />
        <meta
            name="msapplication-TileImage"
            content="/theme/favicon/mstile-144x144.png"
        />
        <meta
            name="msapplication-config"
            content="/theme/favicon/browserconfig.xml"
        />
        <meta name="theme-color" content="#000000" />
        <meta
            name="msapplication-config"
            content="/theme/favicon/browserconfig.xml"
        />
        <meta name="theme-color" content="#000000" />

      <meta name="keywords" content="backup, python, rsync, script, terminal">

      <!-- Open graph for social networks -->
      <meta name="og:title" property="og:title" content="Cloud storage became affordable a long time ago while internet connection speeds have increased dramatically over the years. Yet, there is still a strong case to be made for daily backups of a whole system and for this purpose, there are few options to contend with rsync.">

        <title>sglavoie.com &ndash; Convenient and lightning fast backups with&nbsp;rsync</title>
    </head>

    <body>
        <aside>
            <div id="user_meta">
                <a href="https://www.sglavoie.com">
                    <div>
                        <svg
                            width="24.348mm"
                            height="24.348mm"
                            version="1.1"
                            viewBox="0 0 24.348095 24.347754"
                            xmlns="http://www.w3.org/2000/svg"
                            xmlns:cc="http://creativecommons.org/ns#"
                            xmlns:dc="http://purl.org/dc/elements/1.1/"
                            xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                        >
                            <metadata>
                                <rdf:RDF>
                                    <cc:Work rdf:about="">
                                        <dc:format>image/svg+xml</dc:format>
                                        <dc:type
                                            rdf:resource="http://purl.org/dc/dcmitype/StillImage"
                                        />
                                        <dc:title />
                                    </cc:Work>
                                </rdf:RDF>
                            </metadata>
                            <g transform="translate(81.397 -84.454)">
                                <path
                                    d="m-57.049 105.9v2.9029h-11.173v-2.9029z"
                                    fill="#c0c0c0"
                                >
                                    <animate
                                        attributeName="fill"
                                        values="white;grey;white"
                                        dur="2s"
                                        repeatCount="indefinite"
                                    />
                                </path>
                                <path
                                    d="m-72.272 98.481-9.1246 5.7598v-3.548l5.8658-3.5019v-0.09215l-5.8658-3.5019v-3.548l9.1246 5.7598z"
                                    fill="#c0c0c0"
                                />
                                <path
                                    transform="scale(.26458)"
                                    d="m-273.15 319.2-27.588 14.77 8.498 5.3613 19.09-12.049zm15.309 25.67v44.412h8.8672v-35.635h33.361v-8.7773h-33.783zm25.336 24.66v8.7774h8.0254v10.975h8.8672v-19.752z"
                                    fill="#007bff"
                                />
                            </g>
                        </svg>
                    </div>
                </a>
                <ul>
                      <li><a href="https://www.sglavoie.com/category/automation.html">automation</a></li>
                    <li><a href="https://www.sglavoie.com/category/tips-and-tricks.html">tips-and-tricks</a></li>
                    <li><a href="https://www.sglavoie.com/category/tools.html">tools</a></li>
                    <li><a href="https://www.sglavoie.com/category/workflow.html">workflow</a></li>
                  </ul>
            </div>
        </aside>

        <main>
            <header>
                <p>
                    <a href="https://www.sglavoie.com">Index</a> &brvbar;
                    <a href="https://www.sglavoie.com/archives.html">Archives</a> &brvbar;
                    <a href="https://www.sglavoie.com/tags.html">Tags</a> &brvbar;
                    <a href="https://www.sglavoie.com/learning-progress-2021.html"
                        >Learning Progress</a
                    >
                    &brvbar;
                    <a href="https://www.sglavoie.com/contact.html">Contact</a> &brvbar;
                    <a
                        href="https://drive.google.com/file/d/1t6GdZjC13naJXVGe6RinGowZLfkRzjy_/view"
                        target="_blank"
                        rel="noopener noreferrer"
                        >Resume</a
                    >
                </p>
            </header>

<article>
  <div class="article_title">
    <h1><a href="https://www.sglavoie.com/posts/2021/07/31/convenient-and-lightning-fast-backups-with-rsync/">Convenient and lightning fast backups with&nbsp;rsync</a></h1>
  </div>
  <div class="article_readtime">
    <p>Estimated read time: 9 minutes</p>
  </div>
    <nav class="toc">
    <div class="toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#setting-up-the-script">Setting up the script</a><ul>
<li><a href="#the-configuration-file">The configuration file</a><ul>
<li><a href="#description-of-available-settings">Description of available settings</a></li>
</ul>
</li>
<li><a href="#the-script">The script</a></li>
</ul>
</li>
<li><a href="#how-to-use">How to use</a><ul>
<li><a href="#one-time-setup">One-time setup</a></li>
<li><a href="#using-as-a-daily-driver">Using as a daily driver</a></li>
<li><a href="#avoid-deleting-files-at-the-destination">Avoid deleting files at the destination</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a><ul>
<li><a href="#more-resources-and-references">More resources and references</a></li>
</ul>
</li>
</ul>
</div>
    </nav>
  <div class="article_text">
    
<hr/>
<h1 id="introduction">Introduction</h1>
<p>Coming into its fourth year of existence and usage in production environments, this simple script has proven to be a fantastic ally. Despite the plethora of great options out there that have more bells and whistles, I have yet to find a single complaint about this solution as it hinges on the minimalist side, requiring only a working Python 3 installation along with the powerful <code>rsync</code> command-line tool.</p>
<p>It’s one of those pieces of code that perform some really basic tasks that can be scheduled with <a href="https://opensource.com/article/17/11/how-use-cron-linux"><code>cron</code></a> in the background, that one forgets about until a real need to access a backup comes up. This script is barely a Python wrapper calling <code>rsync</code> but still, I felt like sharing it for those who like uncomplicated setups. I’ve literally left this script alone for years some time after the release of Python 3.6 which was released back in December 2016 and it has been going strong since then mostly due to the fact it does not do much more than backing files up and leveraging <code>rsync</code>.</p>
<hr/>
<h1 id="prerequisites">Prerequisites</h1>
<p>As briefly mentioned above, this tool uses <a href="https://www.python.org/">Python 3.6+</a> and <a href="https://rsync.samba.org/"><code>rsync</code></a>. That’s it, really.</p>
<h1 id="setting-up-the-script">Setting up the script</h1>
<p>This script is being made <a href="https://github.com/sglavoie/dev-helpers/tree/main/rsync_backup">available on GitHub</a> within a set of other small tools. To get the source code for this particular tool, you can either <a href="https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/cloning-a-repository-from-github/cloning-a-repository">clone the whole repository</a>, get the content of the files separately or simply copy and paste <a href="#the-script">the current version from below</a>. You will need a <code>settings.json</code> file as well as the Python script that will run the necessary commands.</p>
<h2 id="the-configuration-file">The configuration file</h2>
<p>Right off the bat, you will most probably want to update the array of strings for the <code>data_sources</code> key as well as the string for the key <code>data_destination</code> in the following <span class="caps">JSON</span> file.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">"data_sources"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"/home/sglavoie"</span>
    <span class="p">],</span>
    <span class="nt">"data_destination"</span><span class="p">:</span> <span class="s2">"/media/sglavoie/Elements"</span><span class="p">,</span>
    <span class="nt">"terminal_width"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
    <span class="nt">"sep"</span><span class="p">:</span> <span class="s2">"=-"</span><span class="p">,</span>
    <span class="nt">"log_name"</span><span class="p">:</span> <span class="s2">".backup_log_"</span><span class="p">,</span>
    <span class="nt">"log_format"</span><span class="p">:</span> <span class="s2">"%y%m%d_%H_%M_%S"</span><span class="p">,</span>
    <span class="nt">"rsync_options"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"-vaAHh"</span><span class="p">,</span>
        <span class="s2">"--delete"</span><span class="p">,</span>
        <span class="s2">"--ignore-errors"</span><span class="p">,</span>
        <span class="s2">"--force"</span><span class="p">,</span>
        <span class="s2">"--prune-empty-dirs"</span><span class="p">,</span>
        <span class="s2">"--delete-excluded"</span>
    <span class="p">],</span>
    <span class="nt">"backup_exclude"</span><span class="p">:</span> <span class="s2">".backup_exclude"</span>
<span class="p">}</span>
</code></pre></div>
<p>By default, the following options are passed to <code>rsync</code>:</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-vaAH</code></td>
<td>verbose, archive, ACLs, hard-links (preserve)</td>
</tr>
<tr>
<td><code>--delete</code></td>
<td><em>“delete extraneous files from destination dirs”</em></td>
</tr>
<tr>
<td><code>--ignore-errors</code></td>
<td><em>“delete even if there are I/O errors”</em></td>
</tr>
<tr>
<td><code>--force</code></td>
<td><em>“force deletion of directories even if not empty”</em></td>
</tr>
<tr>
<td><code>--prune-empty-dirs</code></td>
<td><em>“prune empty directory chains from the file-list”</em></td>
</tr>
<tr>
<td><code>--delete-excluded</code></td>
<td><em>“also delete excluded files from destination dirs”</em></td>
</tr>
</tbody>
</table>
<h3 id="description-of-available-settings">Description of available settings</h3>
<table>
<thead>
<tr>
<th>Name of setting</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>data_sources</code></td>
<td>Directories to backup, supplied as a list of strings (no slash at the end).</td>
</tr>
<tr>
<td><code>data_destination</code></td>
<td>Single destination of the files to backup, supplied as a string. This can be overridden when passing option <code>-d</code> or <code>--dest</code> to the script</td>
</tr>
<tr>
<td><code>terminal_width</code></td>
<td>Line length in the terminal, used for printing separators.</td>
</tr>
<tr>
<td><code>sep</code></td>
<td>Separator to use along with <code>terminal_width</code>.</td>
</tr>
<tr>
<td><code>log_name</code></td>
<td>Sets the prefix of the log filename.</td>
</tr>
<tr>
<td><code>log_format</code></td>
<td>This goes right after <code>log_name</code> as a suffix.</td>
</tr>
<tr>
<td><code>rsync_options</code></td>
<td>Options to use with rsync as a list of strings.</td>
</tr>
<tr>
<td><code>backup_exclude</code></td>
<td>Default file in each source in <code>data_sources</code> where files/directories will be ignored.</td>
</tr>
</tbody>
</table>
<h2 id="the-script">The script</h2>
<div class="highlight"><pre><span></span><code><span class="sd">"""</span>
<span class="sd">Script that uses `rsync` to make a simple and convenient backup.</span>
<span class="sd">Note: requires Python 3.6+. No other Python third-party libraries required.</span>
<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">subprocess</span>


<span class="k">def</span> <span class="nf">run_backup</span><span class="p">():</span>
    <span class="sd">"""This is where all the action happens!"""</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">()</span>

    <span class="c1"># initiate the parser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s2">"backup"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">"-c"</span><span class="p">,</span>
        <span class="s2">"--clear"</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"Delete all log files for current source in DATA_SOURCES."</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">"-s"</span><span class="p">,</span>
        <span class="s2">"--src"</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">"source"</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"Specify an alternative source to backup as a string."</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">"-d"</span><span class="p">,</span>
        <span class="s2">"--dest"</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">"destination"</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">"Specify an alternative destination for backup as a string."</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># read arguments from the command line</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># check for --source or -s</span>
    <span class="c1"># Replace potential list of sources to backup with this one</span>
    <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">"data_sources"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">source</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Please enter a valid source to backup."</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># check for --clear or -c</span>
    <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">clear</span><span class="p">:</span>
        <span class="n">clear_logs</span><span class="p">(</span>
            <span class="n">data_sources</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">"data_sources"</span><span class="p">],</span>
            <span class="n">log_name</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">"log_name"</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="c1"># check for --dest or -d</span>
    <span class="c1"># Replace destination to backup with this one</span>
    <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">destination</span><span class="p">):</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">"data_destination"</span><span class="p">]</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">destination</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Please enter a valid destination."</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># don't run the script if the destination doesn't exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"data_destination"</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"The destination doesn't exist.</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">'data_destination'</span><span class="p">]</span><span class="si">}</span><span class="s2">)"</span>
        <span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">backup_all_sources</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">backup_all_sources</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Iterate over all sources to backup."""</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"data_sources"</span><span class="p">]:</span>
        <span class="n">date_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">log_format</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="n">date_now</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"log_format"</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">log_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">'log_name'</span><span class="p">]</span><span class="si">}{</span><span class="n">log_format</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">log_option</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"--log-file=</span><span class="si">{</span><span class="n">log_filename</span><span class="si">}</span><span class="s2">"</span>

        <span class="n">backup_source</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"backup_cmd"</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">backup_source</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">log_option</span><span class="p">])</span>

        <span class="c1"># files to ignore in backup</span>
        <span class="n">exclude_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">'backup_exclude'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exclude_file</span><span class="p">):</span>
            <span class="n">exclude_option</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"--exclude-from=</span><span class="si">{</span><span class="n">exclude_file</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">backup_source</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">exclude_option</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"data_destination"</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># skips '--exclude-from' option if no file is found</span>
            <span class="n">backup_source</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">source</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"data_destination"</span><span class="p">]])</span>

        <span class="n">settings</span><span class="p">[</span><span class="s2">"source"</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">"backup_source"</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_source</span>
        <span class="n">settings</span><span class="p">[</span><span class="s2">"log_filename"</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_filename</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backing_source</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">KeyboardInterrupt: Exiting operations."</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">backing_source</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Print information to STDOUT and to `log_filename` and executes the</span>
<span class="sd">    rsync command."""</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"sep"</span><span class="p">]</span> <span class="o">*</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"terminal_width"</span><span class="p">])</span>

    <span class="n">cmd_executed</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"backup_source"</span><span class="p">])</span>
    <span class="n">msg_executed</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Command executed:</span><span class="se">\n</span><span class="si">{</span><span class="n">cmd_executed</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg_executed</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"log_filename"</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="n">log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">msg_executed</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"backup_source"</span><span class="p">])</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># call communicate to get the return code</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">returncode</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"FileNotFoundError: Is the `rsync` tool installed?"</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Backup completed for: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">'source'</span><span class="p">]</span><span class="si">}</span><span class="s2"> (return code: </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"sep"</span><span class="p">]</span> <span class="o">*</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"terminal_width"</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">clear_logs</span><span class="p">(</span><span class="n">data_sources</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">log_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Clears log files for each source specified in SETTINGS."""</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">data_sources</span><span class="p">:</span>
        <span class="c1"># Retrieve a list of all matching log files in `source`</span>
        <span class="n">log_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">log_name</span><span class="si">}</span><span class="s2">*"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_files</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">There is no log file to delete in </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Log files in </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_says_yes</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"Log files deleted."</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Exiting script..."</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">user_says_yes</span><span class="p">(</span>
    <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Do you want to delete log files for this source? (y/n) "</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">"""Asks the user to enter either "y" or "n" to confirm. Returns boolean."""</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">choice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"y"</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"n"</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Please enter either "y" or "n".'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">choice</span>


<span class="k">def</span> <span class="nf">get_settings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Get the settings from `settings.json`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Containing all settings used by the tool.</span>
<span class="sd">    """</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">directory</span> <span class="o">/</span> <span class="s2">"settings.json"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

    <span class="n">backup_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"rsync"</span><span class="p">]</span>
    <span class="n">backup_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"rsync_options"</span><span class="p">])</span>
    <span class="n">settings</span><span class="p">[</span><span class="s2">"backup_cmd"</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup_cmd</span>

    <span class="k">return</span> <span class="n">settings</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run_backup</span><span class="p">()</span>
</code></pre></div>
<hr/>
<h1 id="how-to-use">How to use</h1>
<h2 id="one-time-setup">One-time setup</h2>
<ol>
<li>Set all values in <code>settings.json</code> to suit your needs.</li>
<li>Make sure that the backup destination is available/mounted. A simple warning will be echoed if the destination can’t be found.</li>
<li>Call the Python script. As an example, if it’s located at <code>/home/user/backup/rsync_backup.py</code>, then you could put the following alias in <code>~/.bash_aliases</code> (or equivalent)*:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nb">alias</span> <span class="nv">backup</span><span class="o">=</span><span class="s1">'python3 /home/user/backup/rsync_backup.py'</span>
</code></pre></div>
<p>* Python may be called differently on your system, e.g. simply <code>python</code> instead of <code>python3</code>.</p>
<p>In this instance, the script can now be executed in a terminal with the keyword <code>backup</code> along with optional arguments.</p>
<h2 id="using-as-a-daily-driver">Using as a daily driver</h2>
<p>Make sure the destination to back files up is available/mounted and simply call the script (e.g. <code>backup</code> in this example).</p>
<p>The output will look something like this:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nv">backup</span>
<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-
Command executed:
rsync -vaAHh --delete --ignore-errors --force --prune-empty-dirs <span class="se">\</span>
    --delete-excluded --log-file<span class="o">=</span>/home/sglavoie/.backup_log_210731_09_28_09 <span class="se">\</span>
    --exclude-from<span class="o">=</span>/home/sglavoie/.backup_exclude /home/sglavoie /tmp

building file list ... <span class="k">done</span>
deleting sglavoie/.backup_log_210731_08_47_24
sglavoie/
sglavoie/.bash_aliases
...
</code></pre></div>
<h2 id="avoid-deleting-files-at-the-destination">Avoid deleting files at the destination</h2>
<p>The <code>rsync</code> command first builds a list of the files that are part of the backup and will go on adding new files, updating existing files as well as removing files that are found in the destination but not in the source anymore according to the default list of flags passed to it in this implementation. It is therefore important to note that <strong>if you would like to back up files in the destination that no longer exist in the source</strong>, a convenient solution is simply to create a new folder at the root level inside the destination directory and manage those files separately.</p>
<p>For instance, I sometimes want to back up large video files but there is rarely a need to update them. In this case, it would be possible to add the directories to exclude in the file <code>.backup_exclude</code> (default configuration option) like so:</p>
<div class="highlight"><pre><span></span><code>Videos/
Dropbox/other/folder/
</code></pre></div>
<p>Then, these directories will be ignored when backing up the source (if they are nested inside the source directory to start with!). If the destination is set to <code>/media/user/backup</code> and the source set to <code>/home/user/my_folder</code>, then the script would recreate the “root” directory of the source if it doesn’t exist on the destination:</p>
<div class="highlight"><pre><span></span><code>$ ls /media/user/backup
my_folder
</code></pre></div>
<p>You could keep track of those heavy files that do not need to be backed up frequently by putting them manually next to <code>my_folder</code> in <code>/media/user/backup</code>. This will lead to huge speed ups when running the script if you track many files in this way!</p>
<hr/>
<h1 id="conclusion">Conclusion</h1>
<p>This was a quick overview of what <code>rsync</code> can offer: I neither touched upon its remote syncing capabilities nor the vast majority of its options, for which you can find a lot more information about by typing <code>man rsync</code> to display the manual page in the terminal.</p>
<p>Without making use of any fancy features of recent versions of Python or <code>rsync</code>, I have found this simple backup procedure to have worked flawlessly for a long time. Hardware inevitably fails at some point and after having heard about countless examples of people losing some or all of their most precious files (including my own story…), I have come to enjoy backing my system with this little script.</p>
<p>I wouldn’t trust my external drive to last forever either, hence I also rely on Dropbox and Google Drive for documents I find are a good fit. But overall, I just do not tend to back up every single system file in the cloud, so there is still a convincing use case where daily and complete backups become a possibility when using a fast approach like <code>rsync</code> to incrementally save snapshots.</p>
<h2 id="more-resources-and-references">More resources and references</h2>
<ul>
<li><a href="https://rsync.samba.org/">rsync official website</a> – samba.org.</li>
<li><a href="https://www.redhat.com/sysadmin/sync-rsync">Keeping Linux files and directories in sync with rsync</a> – RedHat, going through the main options offered by the tool.</li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-rsync-to-sync-local-and-remote-directories">How To Use Rsync to Sync Local and Remote Directories</a> – DigitalOcean, demoing how to use the tool and covering the case of remote file access.</li>
</ul>
  </div>
  <div class="article_meta">
    <p>Posted on: Sat 31 July 2021</p>
    <p>Category: <a href="https://www.sglavoie.com/category/automation.html">automation</a>
 &ndash; Tags:
      <a href="https://www.sglavoie.com/tag/backup.html">backup</a>,      <a href="https://www.sglavoie.com/tag/python.html">python</a>,      <a href="https://www.sglavoie.com/tag/rsync.html">rsync</a>,      <a href="https://www.sglavoie.com/tag/script.html">script</a>,      <a href="https://www.sglavoie.com/tag/terminal.html">terminal</a>    </p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "posts/2021/07/31/convenient-and-lightning-fast-backups-with-rsync/";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = '//sglavoie.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>
  
            <div id="ending_message">
                <p>
                    &copy; Sébastien Lavoie. Built in
                    <a
                        href="https://www.python.org/"
                        target="_blank"
                        rel="noopener noreferrer"
                        >Python</a
                    >
                    using
                    <a
                        href="http://getpelican.com"
                        target="_blank"
                        rel="noopener noreferrer"
                        >Pelican</a
                    >
                    v4.7.1. Theme adapted from Giulio Fidente on
                    <a
                        href="https://github.com/gfidente/pelican-svbhack"
                        target="_blank"
                        rel="noopener noreferrer"
                        >GitHub</a
                    >.
                    <a href="https://www.sglavoie.com/feeds/sglavoie.rss.xml">RSS feed</a>.
                </p>
            </div>
        </main>
    </body>
</html>